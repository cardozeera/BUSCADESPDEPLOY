<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>BuscaDesp</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
    input, select, textarea { width: 100%; margin: 5px 0; padding: 8px; }
    button { padding: 10px 20px; margin-top: 5px; }
    .hidden { display: none; }
    #login-msg, #consulta-msg { margin-top: 5px; }
    #logout-btn { margin-left: 10px; }
  </style>
</head>
<body>

  <h1>BuscaDesp</h1>

  <!-- Seção de Login -->
  <div id="auth-section">
    <h2>Login</h2>
    <input type="email" id="login-email" placeholder="Email" />
    <input type="password" id="login-senha" placeholder="Senha" />
    <button id="btn-login">Login</button>
    <p id="login-msg" style="color: red;"></p>
  </div>

  <!-- Seção Principal (após login) -->
  <div id="main-section" class="hidden">
    <p>
      Logado como <span id="user-email"></span>
      <button id="btn-logout" style="margin-left:10px;">Logout</button>
    </p>

    <h2>Nova Consulta</h2>
    <select id="tipo_busca">
      <option value="cpf3">CPF3</option>
      <option value="nome">Nome</option>
      <option value="telefone">Telefone</option>
      <option value="placa">Placa</option>
    </select>
    <input type="text" id="termo" placeholder="Digite o termo de busca" />
    <textarea id="resultado" rows="3" placeholder="Cole o resultado ou texto"></textarea>
    <button id="btn-consulta">Enviar Consulta</button>
    <p id="consulta-msg" style="color: green;"></p>
  </div>

  <script>
    // ========== CONFIGURAÇÃO ==========
    // Substitua pela URL exata do seu backend no Render:
    const API_BASE = "https://buscadespdeploy-2.onrender.com";

    // Aqui guardamos o JWT após o login
    let jwtToken = "";
    let userEmail = "";

    // ======== FUNÇÕES =========

    // 1) LOGIN
    document.getElementById("btn-login").addEventListener("click", () => {
      const email = document.getElementById("login-email").value.trim();
      const senha = document.getElementById("login-senha").value.trim();
      const loginMsg = document.getElementById("login-msg");
      loginMsg.textContent = "";

      if (!email || !senha) {
        loginMsg.textContent = "Preencha email e senha.";
        return;
      }

      fetch(`${API_BASE}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, senha })
      })
      .then(async res => {
        const body = await res.json();
        if (!res.ok) {
          // Exibe mensagem de erro do backend (como “Email não encontrado” ou “Senha incorreta”)
          throw new Error(body.detail || "Login inválido.");
        }
        return body;
      })
      .then(body => {
        jwtToken = body.access_token;
        userEmail = email;
        document.getElementById("user-email").textContent = email;
        // Exibe a área de consulta e esconde o login
        document.getElementById("auth-section").classList.add("hidden");
        document.getElementById("main-section").classList.remove("hidden");
      })
      .catch(err => {
        loginMsg.textContent = err.message || "Erro de rede.";
      });
    });

    // 2) LOGOUT
    document.getElementById("btn-logout").addEventListener("click", () => {
      jwtToken = "";
      userEmail = "";
      document.getElementById("login-email").value = "";
      document.getElementById("login-senha").value = "";
      document.getElementById("consulta-msg").textContent = "";
      document.getElementById("main-section").classList.add("hidden");
      document.getElementById("auth-section").classList.remove("hidden");
    });

    // 3) ENVIAR NOVA CONSULTA
    document.getElementById("btn-consulta").addEventListener("click", () => {
      const tipo_busca = document.getElementById("tipo_busca").value;
      const termo = document.getElementById("termo").value.trim();
      const resultado = document.getElementById("resultado").value.trim();
      const msgEl = document.getElementById("consulta-msg");
      msgEl.textContent = "";

      if (!termo || !resultado) {
        msgEl.textContent = "Informe termo e resultado.";
        msgEl.style.color = "red";
        return;
      }
      if (!jwtToken) {
        msgEl.textContent = "Você não está autenticado.";
        msgEl.style.color = "red";
        return;
      }

      fetch(`${API_BASE}/consulta`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + jwtToken
        },
        body: JSON.stringify({
          tipo_busca,
          termo,
          resultado
        })
      })
      .then(async res => {
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.detail || "Erro ao registrar consulta.");
        }
        return data;
      })
      .then(() => {
        msgEl.style.color = "green";
        msgEl.textContent = "Consulta registrada!";
        document.getElementById("termo").value = "";
        document.getElementById("resultado").value = "";
      })
      .catch(err => {
        msgEl.style.color = "red";
        msgEl.textContent = err.message || "Erro de rede.";
      });
    });

    // (Opcional) Você pode adicionar aqui GET /consultas no futuro
  </script>

</body>
</html>
